CC=riscv64-unknown-elf-gcc
OBJDUMP=riscv64-unknown-elf-objdump
CFLAGS+=-mcmodel=medany -std=gnu99 -O2 -fno-common -fno-builtin-printf -Wall -DWRAP_$(FUNC)
LDFLAGS=-static -nostdlib -nostartfiles -lgcc

BM_LIB_DIR=${RDIR}/tools/centrifuge/scripts/sw_aux/bm_linker_scripts/
BM_LIB_FLAG=-lriscvbm
BM_LIB=$(BM_LIB_DIR)/libriscvbm.a

SRC = $(wildcard *.c)
SRC_S = $(wildcard *.S)
OBJ = $(SRC:.c=.o) 
OBJ_S = $(SRC:.S=.s.o) 
.PHONY: clean

default: all 

all: $(addsuffix .riscv,$(TARGET))

dumps: $(addsuffix .dump,$(TARGET))

.s.o: $(SRC_S)
	$(CC) $(CFLAGS) -D__ASSEMBLY__=1 -c $< -o $@

.o: $(SRC) mmio.h
	$(CC) $(CFLAGS) -c $< -o $@

#%.riscv: %.o crt.o syscalls.o $(BM_LIB_DIR)/bm_linker_scripts/link.ld
$(TARGET).riscv: $(OBJ) $(OBJ_S) $(BM_LIB) $(BM_LIB_DIR)/link.ld
	$(CC) -T $(BM_LIB_DIR)/link.ld $(LDFLAGS) -I$(BM_LIB_DIR) -L$(BM_LIB_DIR) $(BM_LIB_FLAG) $< -o $@

%.dump: %.riscv
	$(OBJDUMP) -D $< > $@

clean:
	rm -f *.riscv *.o *.dump
